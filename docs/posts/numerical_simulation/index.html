<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Angelo Maria Sabatini">
<meta name="dcterms.date" content="2024-06-06">
<meta name="description" content="A down-to-the-bone post, where few issues concerning the numerical simulation of stochastic differential equations are discussed with just a limited amount of technical detail.">

<title>Numerical simulation for stochastic differential equations – Angelo Maria Sabatini</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-G7T7XXSXKG"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-G7T7XXSXKG', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Angelo Maria Sabatini</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/angelosabatini"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#approximation-methods" id="toc-approximation-methods" class="nav-link active" data-scroll-target="#approximation-methods">Approximation methods</a></li>
  <li><a href="#numerical-test" id="toc-numerical-test" class="nav-link" data-scroll-target="#numerical-test">Numerical test</a></li>
  <li><a href="#lamperti-transform" id="toc-lamperti-transform" class="nav-link" data-scroll-target="#lamperti-transform">Lamperti transform</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Numerical simulation for stochastic differential equations</h1>
  <div class="quarto-categories">
    <div class="quarto-category">stochastic calculus</div>
  </div>
  </div>

<div>
  <div class="description">
    A down-to-the-bone post, where few issues concerning the numerical simulation of stochastic differential equations are discussed with just a limited amount of technical detail.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Angelo Maria Sabatini </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 6, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>We consider here the class of stochastic processes known as diffusion processes, which are solutions to stochastic differential equation (SDE) of the form:</p>
<p><span id="eq-eq1"><span class="math display">\[
dX(t)=b(t,X(t))\,dt+\sigma(t,X(t))\,dW(t)
\tag{1}\]</span></span></p>
<p>with some initial condition <span class="math inline">\(X(0)\)</span> which can be regarded as being either constant or random. The SDE is interpreted in the Itô sense:</p>
<p><span id="eq-eq2"><span class="math display">\[
X(t)=X(0)+\int_0^tb(s,X(s))\,ds+\int_0^t\sigma(s,X(s))\,dW(s)
\tag{2}\]</span></span></p>
<p>and <span class="math inline">\(\{W(t),t\in[0,T]\}\)</span> is the so-called Brownian motion or Wiener process.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Wiener process
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Wiener process <span class="math inline">\(\{W(t),t\in[0,T]\}\)</span> has independent Gaussian increments and continuous sample paths, and comes endowed with the following properties:</p>
<ol type="1">
<li><p><span class="math inline">\(W(0)=0\)</span> (with probability 1).</p></li>
<li><p>For <span class="math inline">\(0\leq s\leq t\leq T\)</span> the random variable given by the Gaussian increment <span class="math inline">\(W(t)-W(s)\)</span> is distributed with mean zero and variance <span class="math inline">\(t-s\)</span>; equivalently, <span class="math inline">\(W(t)-W(s)\propto\sqrt{t-s}\,Z\)</span>, where <span class="math inline">\(Z\)</span> denotes a standard Gaussian random variable, with a mean of zero and a variance of one.</p></li>
<li><p>For <span class="math inline">\(0\leq s\leq t\leq u\leq v\leq T\)</span> the increments <span class="math inline">\(W(t)-W(s)\)</span> and <span class="math inline">\(W(v)-W(u)\)</span> are independent (condition of independence on any two disjoint intervals).</p></li>
</ol>
</div>
</div>
<p>The two deterministic functions <span class="math inline">\(b(\cdot,\cdot)\)</span> and <span class="math inline">\(\sigma(\cdot,\cdot)\)</span> are called, respectively, the drift and the diffusion coefficients of the SDE. Under a number of assumptions regarding their properties (i.e., global Lipschitz and linear growth, see <span class="citation" data-cites="iacus2008">(<a href="#ref-iacus2008" role="doc-biblioref">Iacus 2008</a>)</span> for mathematical details) the SDE has a unique solution with continuous sample paths such that</p>
<p><span id="eq-eq3"><span class="math display">\[
E\left[\int_0^T\vert\,X(t)\,\vert^2\,dt\right]&lt;\infty
\tag{3}\]</span></span></p>
<p>For the sake of simpler notation, <span class="math inline">\(X(t)\rightarrow X_t\)</span> is used in the following, therefore <a href="#eq-eq1" class="quarto-xref">Equation&nbsp;1</a> and <a href="#eq-eq2" class="quarto-xref">Equation&nbsp;2</a> can be written:</p>
<p><span id="eq-eq4"><span class="math display">\[
\left\{
\begin{split}
dX_t&amp;=b(t,X_t)\,dt+\sigma(t,X_t)\,dW_t\\
X_t&amp;=X_0+\int_0^tb(s,X_s)\,ds+\int_0^t\sigma(s,X_s)\,dW_s
\end{split}
\right.
\tag{4}\]</span></span></p>
<p>The Itô formula is an important tool of stochastic calculus. It can be regarded as the stochastic version of the Taylor expansion of a function <span class="math inline">\(f(t,X_t)\)</span> stopped at the second order, where <span class="math inline">\(X_t\)</span> is a diffusion process. If the function <span class="math inline">\(f(\cdot,\cdot)\)</span> is a twice differentiable function on both arguments, we have:</p>
<p><span id="eq-eq5"><span class="math display">\[
df(t,X_t)=f_t(t,X_t)\,dt+f_x(t,X_t)\,dX_t+\frac{1}{2}f_{xx}(t,X_t)(dX_t)^2
\tag{5}\]</span></span></p>
<p>where:</p>
<p><span class="math display">\[
f_t(t,x)=\dfrac{\partial}{\partial t}f(t,x),\quad f_x(t,x)=\dfrac{\partial f(t,x)}{\partial x},\quad f_{xx}(t,x)=\dfrac{\partial^2 f(t,x)}{\partial x^2}
\]</span></p>
<p>Using <a href="#eq-eq1" class="quarto-xref">Equation&nbsp;1</a> and the Itô lemma, which states that <span class="math inline">\((dW_t)^2=dt\)</span>, we have:</p>
<p><span id="eq-eq6"><span class="math display">\[
(dX_t)^2=\left[b(t,X_t)\,dt+\sigma(t,X_t)\,dW_t\right]^2=\sigma^2(t,X_t)\,dt+\text{O}(dt^{3/2})
\tag{6}\]</span></span></p>
<p><a href="#eq-eq5" class="quarto-xref">Equation&nbsp;5</a> can thus be written:</p>
<p><span id="eq-eq7"><span class="math display">\[
df(t,X_t)=\left[f_t(t,X_t)+f_x(t,X_t)b(t,X_t)+\frac{1}{2}f_{xx}(t,X_t)\right]dt+f_x(t,X_t)\sigma(t,X_t)\,dW_t
\tag{7}\]</span></span></p>
<section id="approximation-methods" class="level2">
<h2 class="anchored" data-anchor-id="approximation-methods">Approximation methods</h2>
<p>To apply a numerical method to the generic SDE of <a href="#eq-eq1" class="quarto-xref">Equation&nbsp;1</a> over the time interval <span class="math inline">\([0,T]\)</span>, the time interval needs to be discretized <span class="citation" data-cites="higham.2001">(<a href="#ref-higham.2001" role="doc-biblioref">Higham 2001</a>)</span>. Let <span class="math inline">\(\Delta t=T/M\)</span> for some positive integer <span class="math inline">\(M\)</span>, and <span class="math inline">\(t_n=n\Delta t\)</span>. The numerical approximation to <span class="math inline">\(X(t_n)\)</span> will be denoted <span class="math inline">\(X_n\)</span> (<span class="math inline">\(n=1,\cdots,M\)</span>).</p>
<p>The Euler-Maruyama method takes the form:</p>
<p><span id="eq-eq8"><span class="math display">\[
\left\{
\begin{split}
X_n&amp;=X_{n-1}+b(X_{n-1})\Delta t+\sigma(X_{n-1})\Delta W_{n-1}\\
X_0&amp;=x_0
\end{split}
\right.
\tag{8}\]</span></span></p>
<p>It is worth noting that in the case when <span class="math inline">\(\sigma(X_t)=0\)</span>, then the problem becomes deterministic: this approximation method reduces to the standard Euler method for the ordinary differential equation <span class="math inline">\(\dot{X}_t=b(t,X_t)\)</span>.</p>
<p>The Milstein’s method adds a correction to the stochastic increment to produce the solution to the SDE. The correction arises because the Taylor expansion must be modified in the case of Itô calculus. Truncating the Taylor expansion to the second order at an appropriate point yields:</p>
<p><span id="eq-eq9"><span class="math display">\[
\left\{
\begin{split}
X_n&amp;=X_{n-1}+b(t_{n-1},X_{n-1})\Delta t+\sigma(t_{n-1},X_{n-1})\Delta W_{n-1}\\
&amp;+\dfrac{1}{2}\sigma(X_{n-1})\sigma_x(X_{n-1})\left[(\Delta W_{n-1})^2-\Delta t\right]\\
X_0&amp;=x_0
\end{split}
\right.
\tag{9}\]</span></span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Strong and weak convergence
</div>
</div>
<div class="callout-body-container callout-body">
<p>The methods of approximation of the continuous solution to an SDE are classified according to their different properties. Mainly two criteria of optimality are used in the literature: the strong and the weak (orders of) convergence.</p>
<p>A time-discretized approximation <span class="math inline">\(X_\delta\)</span> of a continuous-time process <span class="math inline">\(X\)</span>, with <span class="math inline">\(\Delta t\)</span> the time increment of the discretization, is said to be of strong order of convergence <span class="math inline">\(\gamma\)</span> to <span class="math inline">\(X\)</span> if for any fixed time horizon <span class="math inline">\(T\)</span> it holds true that</p>
<p><span id="eq-eq10"><span class="math display">\[
E[\,\vert X_{\Delta t}(\tau)-X(\tau)\vert\,]\leq C\Delta t^\gamma,\quad\forall\Delta t&lt;\Delta t_0
\tag{10}\]</span></span></p>
<p>for any <span class="math inline">\(\tau\in[0,T]\)</span>, with <span class="math inline">\(\Delta t_0&gt;0\)</span> and <span class="math inline">\(C\)</span> a constant that does not depend on <span class="math inline">\(\Delta t\)</span>.</p>
<p>Along with the strong convergence, the weak convergence can also be defined. In the same conditions as above, <span class="math inline">\(X_{\Delta t}\)</span> is said to converge weakly of order <span class="math inline">\(\gamma\)</span> to <span class="math inline">\(X\)</span> if for any fixed horizon <span class="math inline">\(T\)</span> and any <span class="math inline">\(2(\beta+1)\)</span> continuous differentiable function <span class="math inline">\(g\)</span> of polynomial growth, it holds true that</p>
<p><span id="eq-eq11"><span class="math display">\[
\vert\,E_g[X_{\Delta t}(\tau)]-E_g[X(\tau)]\,\vert\leq C\Delta t^\beta
\tag{11}\]</span></span></p>
<p>for any <span class="math inline">\(\tau\in[0,T]\)</span>, with <span class="math inline">\(\Delta t_0&gt;0\)</span> and <span class="math inline">\(C\)</span> a constant that does not depend on <span class="math inline">\(\Delta t\)</span>.</p>
<p>Whereas the strong order of convergence measures the rate at which the <em>mean of the error</em> decays as <span class="math inline">\(\Delta t\rightarrow0\)</span>, the weak order of convergence measures the rate of decay of the <em>error of the means</em>.</p>
<p>Methods of approximation of some order that strongly converge usually have a higher order of weak convergence. This is the case with the Euler-Maruyama method, which is strongly convergent of order <span class="math inline">\(\gamma=1/2\)</span> and weakly convergent of order <span class="math inline">\(\beta=1\)</span> (under some smoothness conditions on the coefficients of the SDE). The Milstein’s method has both weak and strong order of convergence, <span class="math inline">\(\gamma=\beta=1\)</span>, which is superior to the Euler–Maruyama method.</p>
<p>It is interesting noting that, when the diffusion coefficient does not depend on the state variable of the process, the Euler-Maruyama and Milstein’s methods coincide. This is one important case, therefore, when the Euler-Maruyama method is strongly convergent of order <span class="math inline">\(\gamma=1\)</span>.</p>
</div>
</div>
</section>
<section id="numerical-test" class="level2">
<h2 class="anchored" data-anchor-id="numerical-test">Numerical test</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Geometric Brownian motion
</div>
</div>
<div class="callout-body-container callout-body">
<p>The geometric Brownian motion (GBM) is the solution to the SDE:</p>
<p><span id="eq-eq12"><span class="math display">\[
\left\{
\begin{split}
dX_t&amp;=\lambda\,X_t\,dt+\mu\,X_t\,dW_t\\
X_0&amp;=x_0
\end{split}
\right.
\tag{12}\]</span></span></p>
<p>where the parameter <span class="math inline">\(\lambda\)</span> is interpreted as the constant interest rate and <span class="math inline">\(\mu&gt;0\)</span> as the volatility. For a GBM, the drift and diffusion coefficients are both linearly related to the state variable <span class="math inline">\(X\)</span>, namely <span class="math inline">\(b(t,X_t)=\lambda\,X_t\)</span> and <span class="math inline">\(\sigma(X_t)=\mu\,X_t\)</span>.</p>
<p>The explicit solution of the SDE <a href="#eq-eq12" class="quarto-xref">Equation&nbsp;12</a> can be found by operating the following change of variable:</p>
<p><span id="eq-eq13"><span class="math display">\[
\begin{split}
Y_t=\log X_t\quad\rightarrow\quad dY_t&amp;=\frac{1}{X_t}\,dX_t-\frac{1}{2X_t^2}\,(dX_t)^2\\
&amp;=\left(\lambda-\frac{1}{2}\mu^2\right)dt+\mu\,dW_t
\end{split}
\tag{13}\]</span></span></p>
<p>We obtain:</p>
<p><span id="eq-eq14"><span class="math display">\[
X_t=x_0\exp\left[\left(\lambda-\frac{1}{2}\mu^2\right)t+\mu\,W_t\right]
\tag{14}\]</span></span></p>
</div>
</div>
<p>For the GBM, the following stochastic difference equations are obtained for the Euler-Maruyama method:</p>
<p><span id="eq-eq15"><span class="math display">\[
\left\{
\begin{split}
X^E_n&amp;=X^E_{n-1}(1+\lambda\Delta t+\mu\Delta W_{n-1})\\
X^E_0&amp;=x_0
\end{split}
\right.
\tag{15}\]</span></span></p>
<p>and for the Milstein method:</p>
<p><span id="eq-eq16"><span class="math display">\[
\left\{
\begin{split}
X^M_n&amp;=X^M_{n-1}+\lambda X^M_{n-1}\Delta t+\mu X^M_{n-1}\Delta W_{n-1}\\
&amp;+\dfrac{1}{2}\mu^2 X^M_{n-1}\left[(\Delta W_{n-1})^2-\Delta t\right]\\
&amp;=X^M_{n-1}\left[1+\left(\lambda-\dfrac{1}{2}\mu^2\right)\Delta t+\mu\Delta W_{n-1}+\dfrac{1}{2}\mu^2(\Delta W_{n-1})^2\right]\\
X^M_0&amp;=x_0
\end{split}
\right.
\tag{16}\]</span></span></p>
<p>Recall that <span class="math inline">\(\Delta W_{n-1}=\sqrt{\Delta t}\,Z\)</span>, where <span class="math inline">\(Z\propto N(0,1)\)</span>.</p>
<p><a href="#eq-eq15" class="quarto-xref">Equation&nbsp;15</a> reads:</p>
<p><span id="eq-eq17"><span class="math display">\[
\left\{
\begin{split}
X^E_n&amp;=X^E_{n-1}(1+\lambda\Delta t+\mu\sqrt{\Delta t}\,Z)\\
X^E_0&amp;=x_0
\end{split}
\right.
\tag{17}\]</span></span></p>
<p><a href="#eq-eq16" class="quarto-xref">Equation&nbsp;16</a> reads:</p>
<p><span id="eq-eq18"><span class="math display">\[
\left\{
\begin{split}
X^M_n&amp;=X^M_{n-1}\left[1+\left(\lambda+\dfrac{1}{2}\mu^2(Z^2-1)\right)\Delta t+\mu\sqrt{\Delta t}\,Z\right]\\
X^M_0&amp;=x_0\\
\end{split}
\right.
\tag{18}\]</span></span></p>
<p>Comparing the exact solution <a href="#eq-eq14" class="quarto-xref">Equation&nbsp;14</a> with <a href="#eq-eq18" class="quarto-xref">Equation&nbsp;18</a> shows how the Milstein method makes the Taylor expansion exact up to order <span class="math inline">\(\text{O}(\Delta t)\)</span>.</p>
<p>The following code will test the strong convergence of both methods when they are applied to the linear SDE <a href="#eq-eq12" class="quarto-xref">Equation&nbsp;12</a>, with <span class="math inline">\(\lambda=2,\mu=1,x_0=1\)</span>. One thousand sample paths are simulated over the time interval <span class="math inline">\([0,1]\)</span>, for step sizes being integer multiples of <span class="math inline">\(2^{-9}\;(8,4,2,1)\)</span>. The order of convergence is tested at the end point of the chosen time interval. The results of the simulations are shown in <a href="#fig-fig1" class="quarto-xref">Figure&nbsp;1</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1792</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>lambda  <span class="ot">&lt;-</span> <span class="dv">2</span> </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>mu      <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>Xzero   <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>T       <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>N       <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">9</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>dt      <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>N</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>M       <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>Xerr_EM <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> M, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>Xerr_M  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> M, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, M, <span class="at">by =</span> <span class="dv">1</span>)) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  dW    <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(dt))</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  W     <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(dW)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  Xtrue <span class="ot">&lt;-</span> Xzero<span class="sc">*</span><span class="fu">exp</span>((lambda <span class="sc">-</span> <span class="fl">0.5</span><span class="sc">*</span>mu<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>T <span class="sc">+</span> mu<span class="sc">*</span>W[N])</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    R  <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">^</span>(j<span class="dv">-1</span>)    </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    Dt <span class="ot">&lt;-</span> R<span class="sc">*</span>dt </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    L  <span class="ot">&lt;-</span> N<span class="sc">/</span>R</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    Xtemp_EM <span class="ot">&lt;-</span> Xzero</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    Xtemp_M  <span class="ot">&lt;-</span> Xzero</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, L, <span class="at">by =</span> <span class="dv">1</span>)) {</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      Winc     <span class="ot">&lt;-</span> <span class="fu">sum</span>(dW[(R<span class="sc">*</span>(k<span class="dv">-1</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(R<span class="sc">*</span>k)])</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>      Xtemp_EM <span class="ot">&lt;-</span> Xtemp_EM<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> Dt<span class="sc">*</span>lambda <span class="sc">+</span> mu<span class="sc">*</span>Winc)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>      Xtemp_M  <span class="ot">&lt;-</span> Xtemp_M<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> Dt<span class="sc">*</span>lambda <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>mu<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>(Winc<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> Dt) <span class="sc">+</span> mu<span class="sc">*</span>Winc)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    Xerr_EM[i, j] <span class="ot">&lt;-</span> <span class="fu">abs</span>(Xtemp_EM <span class="sc">-</span> Xtrue)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    Xerr_M[i, j]  <span class="ot">&lt;-</span> <span class="fu">abs</span>(Xtemp_M <span class="sc">-</span> Xtrue)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>Dtvals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>)<span class="sc">*</span>dt</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>Xm_EM  <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="dv">4</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>Xm_M   <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="dv">4</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  Xm_EM[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(Xerr_EM[, i])</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  Xm_M[i]  <span class="ot">&lt;-</span> <span class="fu">mean</span>(Xerr_M[, i])</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>t   <span class="ot">&lt;-</span> <span class="fu">rep</span>(Dtvals, <span class="at">by =</span> <span class="dv">2</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>g   <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Euler-Maruyama"</span>, <span class="st">"Milstein"</span>), <span class="at">each =</span> <span class="dv">4</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>e   <span class="ot">&lt;-</span> <span class="fu">c</span>(Xm_EM, Xm_M)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>e_t <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">sqrt</span>(t), t)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">t =</span> t, <span class="at">method =</span> g, <span class="at">error =</span> e, <span class="at">error_true =</span> e_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-fig1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fig1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-fig1-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fig1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Strong error plot for the Euler-Maruyama and Milstein’s methods; dashed lines give the appropriate reference slope for each method, <span class="math inline">\(\gamma=0.5\)</span> (Euler-Maruyama) and <span class="math inline">\(\gamma=1\)</span> (Milstein).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="lamperti-transform" class="level2">
<h2 class="anchored" data-anchor-id="lamperti-transform">Lamperti transform</h2>
<p>An interesting application of the Itô formula <a href="#eq-eq7" class="quarto-xref">Equation&nbsp;7</a> is now discussed in connection with a formulation of <a href="#eq-eq4" class="quarto-xref">Equation&nbsp;4</a> where the diffusion coefficient is not an explicit function of time, but only depends on the state variable <span class="math inline">\(X\)</span>:</p>
<p><span id="eq-eq19"><span class="math display">\[
dX_t=b(t,X_t)\,dt+\sigma(X_t)\,dW_t
\tag{19}\]</span></span></p>
<p>The Lamperti transform is defined as follows:</p>
<p><span id="eq-eq20"><span class="math display">\[
Y_t=F(X_t)=\int_z^{X_t}\frac{1}{\sigma(s)}\,ds
\tag{20}\]</span></span></p>
<p>where <span class="math inline">\(z\)</span> is any arbitrary value in the state space of <span class="math inline">\(X\)</span>. We assume that the function <span class="math inline">\(F(\cdot)\)</span> defines a one-to-one mapping from the state space of <span class="math inline">\(X\)</span> to <span class="math inline">\(\mathbb{R}\)</span>. We have:</p>
<p><span id="eq-eq21"><span class="math display">\[
F_t(X_t)=0\quad\quad F_x(X_t)=\dfrac{1}{\sigma(X_t)}\quad\quad F_{xx}(X_t)=-\dfrac{\sigma_x(X_t)}{\sigma^2(X_t)}
\tag{21}\]</span></span></p>
<p>Applying the Itô formula <a href="#eq-eq5" class="quarto-xref">Equation&nbsp;5</a>, we obtain:</p>
<p><span id="eq-eq22"><span class="math display">\[
\left\{
\begin{split}
dY_t&amp;=\left[\dfrac{b(t,X_t))}{\sigma(X_t)}-\dfrac{1}{2}\sigma_x(X_t)\right]dt+dW_t\\
X_t&amp;=F^{-1}(Y_t)
\end{split}
\right.
\tag{22}\]</span></span></p>
<p>The Lamperti transform changes the generic SDE <a href="#eq-eq4" class="quarto-xref">Equation&nbsp;4</a> into another SDE with unitary diffusion coefficient. As an example of application of the Lamperti transform, we consider here a result on transformations of SDEs that is relevant for the topic of interest in this post.</p>
<p>First, we discretize the Lamperti transform of <a href="#eq-eq22" class="quarto-xref">Equation&nbsp;22</a> using the Euler-Maruyama method (see <a href="#eq-eq8" class="quarto-xref">Equation&nbsp;8</a>):</p>
<p><span id="eq-eq23"><span class="math display">\[
Y_n=Y_{n-1}+\left[\dfrac{b(t_{n-1},X_{n-1})}{\sigma(X_{n-1})}-\dfrac{1}{2}\sigma_x(X_{n-1})\right]\Delta t+\sqrt{\Delta t}\,Z
\tag{23}\]</span></span></p>
<p>Second, we apply the Taylor expansion to the inverse transform <span class="math inline">\(X_t=G(Y_t)\)</span>, noting that:</p>
<p><span id="eq-eq24"><span class="math display">\[
\begin{split}
G_y(Y_t)&amp;=\sigma(G(Y_t))\\
G_{yy}(Y_t)&amp;=\sigma(G(Y_t))\sigma_x(G(Y_t))
\end{split}
\tag{24}\]</span></span></p>
<p>We obtain:</p>
<p><span id="eq-eq25"><span class="math display">\[
G(Y_{n})=G(Y_{n-1})+G_y(Y_{n-1})(Y_n-Y_{n-1})+\frac{1}{2}G_{yy}(Y_{n-1})(Y_n-Y_{n-1})^2
\tag{25}\]</span></span></p>
<p>and hence:</p>
<p><span id="eq-eq26"><span class="math display">\[
\begin{split}
X_n&amp;=X_{n-1}+\left[b(t_{n-1},X_{n-1})-\dfrac{1}{2}\sigma(X_{n-1})\sigma_x(X_{n-1})\right]\Delta t\\
&amp;+\sigma(X_{n-1})\sqrt{\Delta t}\,Z+\frac{1}{2}\sigma(X_{n-1})\sigma_x(X_{n-1})\Delta t\,Z^2
\end{split}
\tag{26}\]</span></span></p>
<p>In conclusion, the Milstein method on the original process and the Euler-Maruyama method on the transformed process are equal up to and including the order <span class="math inline">\(\text{O}(\Delta t)\)</span>.</p>
<p>In general if a transformation such as the Lamperti transform eliminates the interactions between the state of the process and the increments of the Wiener process, the performance of the Euler-Maruyama method on the transformed SDE are expected to improve.</p>
<p>The logarithmic transformation <span class="math inline">\(F(X_t)=\log X_t\)</span> is an example of nonlinear transformation that is capable of eliminating the interaction between the state <span class="math inline">\(X_t\)</span> of the GBM process and the increments of the Wiener process <span class="math inline">\(dW_t\)</span>, as shown in <a href="#eq-eq13" class="quarto-xref">Equation&nbsp;13</a>. Therefore the Euler-Maruyama method can be confidently applied to the transformed process; the Milstein method is then obtained by simply taking the Taylor expansion of the inverse transform.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-higham.2001" class="csl-entry" role="listitem">
Higham, Desmond J. 2001. <span>“An Algorithmic Introduction to Numerical Simulation of Stochastic Differential Equations.”</span> <em>SIAM Review</em> 43 (3): 525–46. <a href="https://doi.org/10.1137/s0036144500378302">https://doi.org/10.1137/s0036144500378302</a>.
</div>
<div id="ref-iacus2008" class="csl-entry" role="listitem">
Iacus, Stefano M. 2008. <em>Simulation and Inference for Stochastic Differential Equations</em>. Springer New York. <a href="https://doi.org/10.1007/978-0-387-75839-8">https://doi.org/10.1007/978-0-387-75839-8</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/amsabatini\.netlify\.app");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="angelosabatini/blog.comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>